<!DOCTYPE HTML>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="/highcharts.js"></script>
  <style>
    body {
      min-width: 310px;
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
      background: #000;
      color: #00ff00;
      font-family: "Consolas", monospace;
    }
    h2 {
      font-size: 2rem;
      text-shadow: 0 0 10px #00ff00;
    }
    #connStatus {
      font-size: 1rem;
      margin-bottom: 10px;
      color: #ff3333;
    }
    .connected { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
    .disconnected { color: #ff3333; text-shadow: 0 0 10px #ff0000; }

    button {
      background-color: #00ff00;
      color: #000;
      border: none;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
      box-shadow: 0 0 10px #00ff00;
      transition: 0.3s;
    }
    button:hover {
      background-color: #00cc00;
      box-shadow: 0 0 20px #00ff00;
    }
    .legend {
      margin-top: 6px;
      margin-bottom: 25px;
      color: #00ff00;
    }
    .legend span {
      display: inline-block;
      margin: 0 10px;
      padding: 6px 12px;
      border-radius: 8px;
      border: 2px solid #777;
      color: #797979;
      transition: all 0.3s ease;
    }
    .legend span.active {
      border-color: #00ff00;
      color: #00ff00;
      box-shadow: 0 0 10px currentColor;
    }
    .session-container {
      margin: 20px auto;
      border: 1px solid #00ff00;
      padding: 10px;
      border-radius: 10px;
      width: 90%;
      background: rgba(0, 20, 0, 0.4);
      box-shadow: 0 0 15px #003300 inset;
    }
    select {
      padding: 6px;
      background: #000;
      color: #00ff00;
      border: 1px solid #00ff00;
      border-radius: 6px;
      font-family: "Consolas";
    }
  </style>
</head>
<body>
  <h2>Smart Cricket Bat Performance Monitor</h2>
  <div id="connStatus" class="disconnected">ðŸ”´ Disconnected</div>
  <div id="chart-accel" style="height: 400px; width: 100%;"></div>

  <div class="legend" id="gripLegend">
    <span id="legendNone">None</span>
    <span id="legendLoose">Loose</span>
    <span id="legendNormal">Normal</span>
    <span id="legendTight">Tight</span>
  </div>

  <div id="sessionStatus">Status: STOPPED</div>
  <div id="sessionsArea"></div>
  <button id="saveBtn">Save Data</button>

  <script>
    window.onload = function() {
      const alpha = 0.2;
      let lastSmooth = null;
      let currentState = "STOP";
      let lastState = "STOP";
      let currentSession = [];
      let allSessions = [];
      let lastConnectionTime = 0;

      const chartAccel = new Highcharts.Chart({
        chart: { renderTo: 'chart-accel', zoomType: 'x', animation: false, backgroundColor: '#000' },
        title: { text: 'Overall Acceleration Magnitude (Raw vs Smoothed)', style: { color: '#00ff00' } },
        legend: { itemStyle: { color: '#FFFFFF', fontFamily: 'Consolas, monospace' } },
        series: [
          { name: 'Raw Data', type: 'spline', data: [], color: '#fff', lineWidth: 2 },
          { name: 'Smoothed (Grip Pressure)', type: 'spline', data: [], color: '#fff', dashStyle: 'Dot', lineWidth: 3 }
        ],
        xAxis: { 
          type: 'datetime',
          labels: { style: { color: '#00ff00', fontWeight: 'bold' } },
          lineColor: '#00ff00',
          tickColor: '#00ff00'
        },
        yAxis: { 
          title: { text: 'Acceleration (m/sÂ²)', style: { color: '#00ff00' } },
          labels: { style: { color: '#00ff00', fontWeight: 'bold' } },
          gridLineColor: '#003300'
        },
        credits: { enabled: false },
        tooltip: { enabled: false }
      });

      const connStatus = document.getElementById("connStatus");

      function colorFromGrip(gripStr) {
        if (!gripStr) return "#FFFFFF";
        gripStr = gripStr.trim();
        if (gripStr === "TIGHT") return "#FF0000";
        if (gripStr === "NORMAL") return "#00FF00";
        if (gripStr === "Loose") return "#FFFF00";
        if (gripStr === "Null") return "#FFFFFF";
        return "#FFFFFF";
      }

      function updateLegendHighlight(gripStr) {
        const ids = ["None", "Loose", "Normal", "Tight"];
        ids.forEach(id => document.getElementById("legend" + id).classList.remove("active"));
        if (gripStr === "Null") document.getElementById("legendNone").classList.add("active");
        else if (gripStr === "Loose") document.getElementById("legendLoose").classList.add("active");
        else if (gripStr === "NORMAL") document.getElementById("legendNormal").classList.add("active");
        else if (gripStr === "TIGHT") document.getElementById("legendTight").classList.add("active");
      }

      function createSessionBox(sessionId) {
        const div = document.createElement("div");
        div.classList.add("session-container");
        div.innerHTML = `
          <h3>Session ${sessionId}</h3>
          <label>Runs Scored:</label>
          <select id="run${sessionId}">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="6">6</option>
          </select>
        `;
        document.getElementById("sessionsArea").appendChild(div);
      }

      setInterval(async () => {
        try {
          const [dataResp, stateResp] = await Promise.all([
            fetch("/data").then(r => r.text()),
            fetch("/state").then(r => r.text())
          ]);

          const [accelVal, gripVal] = dataResp.split(",");
          const rawY = parseFloat(accelVal);
          if (isNaN(rawY)) return;
          const x = new Date().getTime();
          if (lastSmooth === null) lastSmooth = rawY;
          const smoothY = alpha * rawY + (1 - alpha) * lastSmooth;
          lastSmooth = smoothY;

          const rawSeries = chartAccel.series[0];
          const smoothSeries = chartAccel.series[1];
          rawSeries.addPoint([x, rawY], true, rawSeries.data.length > 200);
          smoothSeries.addPoint([x, smoothY], true, smoothSeries.data.length > 200);

          const gripState = gripVal ? gripVal.trim() : "Null";
          const newColor = colorFromGrip(gripState);
          rawSeries.update({ color: newColor }, false);
          smoothSeries.update({ color: newColor }, false);
          chartAccel.redraw();
          updateLegendHighlight(gripState);

          currentState = stateResp.trim();
          document.getElementById("sessionStatus").textContent = "Status: " + currentState;

          // ðŸŸ¢ Update connection time
          lastConnectionTime = Date.now();
          connStatus.innerHTML = " Connected";
          connStatus.className = "connected";

          if (currentState === "START") {
            currentSession.push({ time: x, raw: rawY, smooth: smoothY });
          } else if (currentState === "STOP" && lastState === "START" && currentSession.length > 0) {
            allSessions.push(currentSession);
            createSessionBox(allSessions.length);
            currentSession = [];
          }
          lastState = currentState;

        } catch (err) {
          // Connection lost
          if (Date.now() - lastConnectionTime > 3000) {
            connStatus.innerHTML = "ðŸ”´ Disconnected";
            connStatus.className = "disconnected";
          }
        }
      }, 300);

      document.getElementById("saveBtn").addEventListener("click", () => {
        if (allSessions.length === 0) {
          alert("No sessions recorded!");
          return;
        }

        let csv = "Session,Run,Time,Raw Accel (m/s^2),Smoothed Accel (m/s^2)\n";
        allSessions.forEach((session, index) => {
          const runValue = document.getElementById(`run${index + 1}`).value || "0";
          session.forEach(p => {
            csv += `${index + 1},${runValue},${new Date(p.time).toLocaleTimeString('en-GB')},${p.raw.toFixed(3)},${p.smooth.toFixed(3)}\n`;
          });
          csv += "\n";
        });

        const link = document.createElement("a");
        link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
        link.download = "bat_performance_data.csv";
        link.click();

        allSessions = [];
        currentSession = [];
        document.getElementById("sessionsArea").innerHTML = "";
        alert("Data saved and sessions cleared!");
      });
    };
  </script>
</body>
</html>
